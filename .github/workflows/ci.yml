name: eip-verify-ci

on:
  workflow_call:
    inputs:
      eip:
        description: "EIP number"
        required: false
        default: "7702"
        type: string
      fork:
        description: "Execution-specs fork"
        required: false
        default: "prague"
        type: string
      client:
        description: "Execution client"
        required: false
        default: "geth"
        type: string
      client_ref:
        description: "Execution client ref"
        required: false
        default: ""
        type: string
      phases:
        description: "Comma-separated phase list"
        required: false
        default: "extract,locate-spec,analyze-spec,locate-client,analyze-client"
        type: string
      model:
        description: "Claude model"
        required: false
        default: "claude-sonnet-4-5"
        type: string
      max_turns:
        description: "Max turns per phase"
        required: false
        default: "20"
        type: string
      eips_ref:
        description: "EIPs repo branch"
        required: false
        default: "master"
        type: string
      execution_specs_ref:
        description: "Execution-specs repo ref"
        required: false
        default: "mainnet"
        type: string
      llm_mode:
        description: "LLM mode (live or fake)"
        required: false
        default: "fake"
        type: string
      pypi_package:
        description: "Git ref or PyPI version to install eip-verify from (default: local path)"
        required: false
        default: "."
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        required: false

permissions:
  contents: read
  actions: write

env:
  DEFAULT_EIP: "7702"
  DEFAULT_FORK: "prague"
  DEFAULT_CLIENT: "geth"
  DEFAULT_PHASES: "extract,locate-spec,analyze-spec,locate-client,analyze-client"
  DEFAULT_EIPS_REF: "master"
  DEFAULT_EXECUTION_SPECS_REF: "mainnet"
  DEFAULT_LLM_MODE: "fake"
  DEFAULT_GETH_REF: "v1.13.14"
  DEFAULT_BESU_REF: "24.3.0"
  DEFAULT_ERIGON_REF: "v2.59.0"
  DEFAULT_NETHERMIND_REF: "1.26.0"
  DEFAULT_RETH_REF: "v0.2.0-beta.5"

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1

      - name: Resolve inputs and defaults
        id: config
        run: |
          # Use input or env defaults
          echo "eip=${{ inputs.eip || env.DEFAULT_EIP }}" >> "$GITHUB_OUTPUT"
          echo "fork=${{ inputs.fork || env.DEFAULT_FORK }}" >> "$GITHUB_OUTPUT"
          echo "client=${{ inputs.client || env.DEFAULT_CLIENT }}" >> "$GITHUB_OUTPUT"
          echo "phases=${{ inputs.phases || env.DEFAULT_PHASES }}" >> "$GITHUB_OUTPUT"
          echo "eips_ref=${{ inputs.eips_ref || env.DEFAULT_EIPS_REF }}" >> "$GITHUB_OUTPUT"
          echo "specs_ref=${{ inputs.execution_specs_ref || env.DEFAULT_EXECUTION_SPECS_REF }}" >> "$GITHUB_OUTPUT"
          echo "llm_mode=${{ inputs.llm_mode || env.DEFAULT_LLM_MODE }}" >> "$GITHUB_OUTPUT"
          
          # Resolve client ref
          CLIENT="${{ inputs.client || env.DEFAULT_CLIENT }}"
          REF="${{ inputs.client_ref }}"
          if [ -z "$REF" ]; then
            case "$CLIENT" in
              geth) REF="${{ env.DEFAULT_GETH_REF }}" ;;
              besu) REF="${{ env.DEFAULT_BESU_REF }}" ;;
              erigon) REF="${{ env.DEFAULT_ERIGON_REF }}" ;;
              nethermind) REF="${{ env.DEFAULT_NETHERMIND_REF }}" ;;
              reth) REF="${{ env.DEFAULT_RETH_REF }}" ;;
            esac
          fi
          echo "client_ref=$REF" >> "$GITHUB_OUTPUT"

      - name: Checkout dependency repos
        run: |
          mkdir -p specs clients/execution
          
          # EIPs
          git clone --depth 1 --branch "${{ steps.config.outputs.eips_ref }}" \
            https://github.com/ethereum/EIPs.git specs/EIPs
            
          # Execution Specs
          SPECS_REF="${{ steps.config.outputs.specs_ref }}"
          git clone --depth 1 https://github.com/ethereum/execution-specs.git specs/execution-specs
          (cd specs/execution-specs && git fetch --depth 1 origin "$SPECS_REF" && git checkout "$SPECS_REF")

          # Client
          CLIENT="${{ steps.config.outputs.client }}"
          CLIENT_REF="${{ steps.config.outputs.client_ref }}"
          case "$CLIENT" in
            geth) REPO="https://github.com/ethereum/go-ethereum.git" ;;
            besu) REPO="https://github.com/hyperledger/besu.git" ;;
            erigon) REPO="https://github.com/ledgerwatch/erigon.git" ;;
            nethermind) REPO="https://github.com/NethermindEth/nethermind.git" ;;
            reth) REPO="https://github.com/paradigmxyz/reth.git" ;;
          esac
          git clone --depth 1 "$REPO" "clients/execution/$CLIENT"
          (cd "clients/execution/$CLIENT" && git fetch --depth 1 origin "$CLIENT_REF" && git checkout "$CLIENT_REF")

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install eip-verify
        run: python -m pip install -e "${{ inputs.pypi_package }}"

      - name: Run Pipeline
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          eip-verify pipeline \
            --eip "${{ steps.config.outputs.eip }}" \
            --phases "${{ steps.config.outputs.phases }}" \
            --spec-repo "specs/execution-specs" \
            --client-repo "clients/execution/${{ steps.config.outputs.client }}" \
            --eip-file "specs/EIPs/EIPS/eip-${{ steps.config.outputs.eip }}.md" \
            --fork "${{ steps.config.outputs.fork }}" \
            --model "${{ inputs.model }}" \
            --max-turns "${{ inputs.max_turns }}" \
            --llm-mode "${{ steps.config.outputs.llm_mode }}" \
            --output-dir "runs/ci_run"

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-report
          path: runs/ci_run/
