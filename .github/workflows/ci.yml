name: eip-verify-ci

on:
  workflow_call:
    inputs:
      eip:
        description: "EIP number"
        required: true
        type: string
      fork:
        description: "Execution-specs fork"
        required: true
        type: string
      client:
        description: "Execution client"
        required: true
        type: string
      client_ref:
        description: "Execution client ref"
        required: true
        type: string
      phases:
        description: "Comma-separated phase list"
        required: true
        type: string
      model:
        description: "Claude model"
        required: true
        type: string
      max_turns:
        description: "Max turns per phase"
        required: true
        type: string
      eips_ref:
        description: "EIPs repo branch"
        required: true
        type: string
      execution_specs_ref:
        description: "Execution-specs repo ref"
        required: true
        type: string
      llm_mode:
        description: "LLM mode (live or fake)"
        required: true
        type: string
      pypi_package:
        description: "Git ref or PyPI version to install eip-verify from (default: local path)"
        required: true
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        required: false

permissions:
  contents: read
  actions: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1

      - name: Resolve inputs
        id: config
        run: |
          echo "eip=${{ inputs.eip }}" >> "$GITHUB_OUTPUT"
          echo "fork=${{ inputs.fork }}" >> "$GITHUB_OUTPUT"
          echo "client=${{ inputs.client }}" >> "$GITHUB_OUTPUT"
          echo "phases=${{ inputs.phases }}" >> "$GITHUB_OUTPUT"
          echo "eips_ref=${{ inputs.eips_ref }}" >> "$GITHUB_OUTPUT"
          echo "specs_ref=${{ inputs.execution_specs_ref }}" >> "$GITHUB_OUTPUT"
          echo "llm_mode=${{ inputs.llm_mode }}" >> "$GITHUB_OUTPUT"
          echo "client_ref=${{ inputs.client_ref }}" >> "$GITHUB_OUTPUT"

      - name: Checkout dependency repos
        run: |
          mkdir -p specs clients/execution
          
          # EIPs
          git clone --depth 1 --branch "${{ steps.config.outputs.eips_ref }}" \
            https://github.com/ethereum/EIPs.git specs/EIPs
            
          # Execution Specs
          SPECS_REF="${{ steps.config.outputs.specs_ref }}"
          rm -rf specs/execution-specs
          mkdir -p specs/execution-specs
          git init specs/execution-specs
          (
            cd specs/execution-specs
            git remote add origin https://github.com/ethereum/execution-specs.git
            git fetch --depth 1 origin "$SPECS_REF"
            git checkout FETCH_HEAD
          )

          # Client
          CLIENT="${{ steps.config.outputs.client }}"
          CLIENT_REF="${{ steps.config.outputs.client_ref }}"
          case "$CLIENT" in
            geth) REPO="https://github.com/ethereum/go-ethereum.git" ;;
            besu) REPO="https://github.com/hyperledger/besu.git" ;;
            erigon) REPO="https://github.com/ledgerwatch/erigon.git" ;;
            nethermind) REPO="https://github.com/NethermindEth/nethermind.git" ;;
            reth) REPO="https://github.com/paradigmxyz/reth.git" ;;
          esac
          rm -rf "clients/execution/$CLIENT"
          mkdir -p "clients/execution/$CLIENT"
          git init "clients/execution/$CLIENT"
          (
            cd "clients/execution/$CLIENT"
            git remote add origin "$REPO"
            git fetch --depth 1 origin "$CLIENT_REF"
            git checkout FETCH_HEAD
          )

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install eip-verify
        run: python -m pip install -e "${{ inputs.pypi_package }}"

      - name: Run Pipeline
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          eip-verify pipeline \
            --eip "${{ steps.config.outputs.eip }}" \
            --phases "${{ steps.config.outputs.phases }}" \
            --spec-repo "specs/execution-specs" \
            --client-repo "clients/execution/${{ steps.config.outputs.client }}" \
            --eip-file "specs/EIPs/EIPS/eip-${{ steps.config.outputs.eip }}.md" \
            --fork "${{ steps.config.outputs.fork }}" \
            --model "${{ inputs.model }}" \
            --max-turns "${{ inputs.max_turns }}" \
            --llm-mode "${{ steps.config.outputs.llm_mode }}" \
            --output-dir "runs/ci_run"

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-report-${{ steps.config.outputs.eip }}
          path: runs/ci_run/
