name: Manual Run

# workflow_dispatch defaults are synced from resolve_defaults.yml via scripts/sync_workflow_defaults.py
on:
  workflow_dispatch:
    inputs:
      eip:
        description: "EIP number"
        required: false
        type: string
        default: "7702"
      fork:
        description: "Execution-specs fork"
        required: false
        type: string
        default: "prague"
      client:
        description: "Execution client"
        required: false
        type: string
        default: "geth"
      client_ref:
        description: "Execution client ref"
        required: false
        type: string
        default: "v1.16.8"
      phases:
        description: "Comma-separated phase list"
        required: false
        type: string
        default: "extract,locate-spec,analyze-spec,locate-client,analyze-client"
      model:
        description: "Claude model"
        required: false
        type: string
        default: "claude-opus-4-5"
      max_turns:
        description: "Max turns per phase"
        required: false
        type: string
        default: "20"
      eips_ref:
        description: "EIPs repo branch"
        required: false
        type: string
        default: "master"
      execution_specs_ref:
        description: "Execution-specs repo ref"
        required: false
        type: string
        default: "mainnet"
      llm_mode:
        description: "LLM mode (live or fake)"
        required: false
        type: string
        default: "fake"
      pypi_package:
        description: "Git ref or PyPI version to install eip-verify from (default: local path)"
        required: false
        type: string
        default: "."

permissions:
  contents: read
  actions: write

jobs:
  defaults:
    uses: ./.github/workflows/resolve_defaults.yml
    with:
      profile: "single"
      eip: ${{ inputs.eip }}
      fork: ${{ inputs.fork }}
      client: ${{ inputs.client }}
      client_ref: ${{ inputs.client_ref }}
      phases: ${{ inputs.phases }}
      model: ${{ inputs.model }}
      max_turns: ${{ inputs.max_turns }}
      eips_ref: ${{ inputs.eips_ref }}
      execution_specs_ref: ${{ inputs.execution_specs_ref }}
      llm_mode: ${{ inputs.llm_mode }}
      pypi_package: ${{ inputs.pypi_package }}

  run-scan:
    needs: defaults
    uses: ./.github/workflows/ci.yml
    with:
      eip: ${{ needs.defaults.outputs.eip }}
      fork: ${{ needs.defaults.outputs.fork }}
      client: ${{ needs.defaults.outputs.client }}
      client_ref: ${{ needs.defaults.outputs.client_ref }}
      phases: ${{ needs.defaults.outputs.phases }}
      model: ${{ needs.defaults.outputs.model }}
      max_turns: ${{ needs.defaults.outputs.max_turns }}
      eips_ref: ${{ needs.defaults.outputs.eips_ref }}
      execution_specs_ref: ${{ needs.defaults.outputs.execution_specs_ref }}
      llm_mode: ${{ needs.defaults.outputs.llm_mode }}
      pypi_package: ${{ needs.defaults.outputs.pypi_package }}
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
