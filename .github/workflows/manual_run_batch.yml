name: Manual Run (Batch)

# workflow_dispatch defaults are synced from resolve_defaults.yml via scripts/sync_workflow_defaults.py
on:
  workflow_dispatch:
    inputs:
      eip:
        description: "EIP number(s) (comma-separated, leave empty for all in fork)"
        required: false
        type: string
        default: ""
      fork:
        description: "Execution-specs fork (used if EIP list is empty)"
        required: false
        type: string
        default: "prague"
      client:
        description: "Execution client"
        required: false
        type: string
        default: "geth"
      client_ref:
        description: "Execution client ref"
        required: false
        type: string
        default: "v1.16.8"
      phases:
        description: "Comma-separated phase list"
        required: false
        type: string
        default: "extract,locate-spec,analyze-spec,locate-client,analyze-client"
      model:
        description: "Claude model"
        required: false
        type: string
        default: "claude-opus-4-5"
      max_turns:
        description: "Max turns per phase"
        required: false
        type: string
        default: "20"
      eips_ref:
        description: "EIPs repo branch"
        required: false
        type: string
        default: "master"
      execution_specs_ref:
        description: "Execution-specs repo ref"
        required: false
        type: string
        default: "mainnet"
      llm_mode:
        description: "LLM mode (live or fake)"
        required: false
        type: string
        default: "fake"
      pypi_package:
        description: "Git ref or PyPI version to install eip-verify from (default: local path)"
        required: false
        type: string
        default: "."

permissions:
  contents: read
  actions: write

jobs:
  defaults:
    uses: ./.github/workflows/resolve_defaults.yml
    with:
      profile: "batch"
      eip: ${{ inputs.eip }}
      fork: ${{ inputs.fork }}
      client: ${{ inputs.client }}
      client_ref: ${{ inputs.client_ref }}
      phases: ${{ inputs.phases }}
      model: ${{ inputs.model }}
      max_turns: ${{ inputs.max_turns }}
      eips_ref: ${{ inputs.eips_ref }}
      execution_specs_ref: ${{ inputs.execution_specs_ref }}
      llm_mode: ${{ inputs.llm_mode }}
      pypi_package: ${{ inputs.pypi_package }}

  discover:
    needs: defaults
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout eip-verify
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Checkout Execution Specs
        run: |
          mkdir -p specs/execution-specs
          git init specs/execution-specs
          cd specs/execution-specs
          git remote add origin https://github.com/ethereum/execution-specs.git
          git fetch --depth 1 origin "${{ needs.defaults.outputs.execution_specs_ref }}"
          git checkout FETCH_HEAD

      - name: Resolve EIP Matrix
        id: set-matrix
        run: |
          # Install current package to get cli_ci
          pip install .
          
          # Run the resolver
          echo "Resolving EIPs for fork '${{ needs.defaults.outputs.fork }}'..."
          MATRIX_JSON=$(eip-verify get-matrix \
            --eip "${{ needs.defaults.outputs.eip }}" \
            --fork "${{ needs.defaults.outputs.fork }}" \
            --spec-repo "specs/execution-specs")
          
          echo "Found EIPs: $MATRIX_JSON"
          echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"

  verify:
    needs: [discover, defaults]
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        eip: ${{ fromJson(needs.discover.outputs.matrix) }}
    uses: ./.github/workflows/ci.yml
    with:
      eip: ${{ matrix.eip }}
      fork: ${{ needs.defaults.outputs.fork }}
      client: ${{ needs.defaults.outputs.client }}
      client_ref: ${{ needs.defaults.outputs.client_ref }}
      phases: ${{ needs.defaults.outputs.phases }}
      model: ${{ needs.defaults.outputs.model }}
      max_turns: ${{ needs.defaults.outputs.max_turns }}
      eips_ref: ${{ needs.defaults.outputs.eips_ref }}
      execution_specs_ref: ${{ needs.defaults.outputs.execution_specs_ref }}
      llm_mode: ${{ needs.defaults.outputs.llm_mode }}
      pypi_package: ${{ needs.defaults.outputs.pypi_package }}
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
