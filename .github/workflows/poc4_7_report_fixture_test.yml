name: poc4_7-report-fixture-test

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  report_fixture:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PoC 4.7
        run: python -m pip install -e poc4_7

      - name: Fake mode sanity check
        run: |
          set -euo pipefail
          python - <<'PY'
          from pathlib import Path
          from poc4_7.llm import build_claude_config
          from poc4_7.runner import PhaseContext, run_query
          from poc4_7.fake_agent import FakeClaudeAgent

          repo_root = Path.cwd().resolve()
          out_dir = repo_root / "poc4_7" / "notes" / "generated" / "fake_sanity"
          out_dir.mkdir(parents=True, exist_ok=True)
          output_path = out_dir / "fake_output.txt"
          config = build_claude_config(
              model="claude-sonnet-4-5",
              max_turns=1,
              allowed_tools=None,
              llm_mode="fake",
              record_calls=True,
          )
          run_query(
              "Fake sanity check prompt.",
              output_path,
              repo_root,
              config,
              FakeClaudeAgent(),
              PhaseContext(phase="0A"),
          )
          print(output_path.read_text(encoding="utf-8"))
          print((output_path.with_suffix(".call.json")).read_text(encoding="utf-8"))
          PY
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "<details><summary>Fake mode sanity output</summary><pre>" >> "$GITHUB_STEP_SUMMARY"
          sed -e 's/&/\\&amp;/g' -e 's/</\\&lt;/g' -e 's/>/\\&gt;/g' "poc4_7/notes/generated/fake_sanity/fake_output.txt" >> "$GITHUB_STEP_SUMMARY"
          echo "</pre></details>" >> "$GITHUB_STEP_SUMMARY"

      - name: Report-only (fixture)
        run: |
          set -euo pipefail
          FIXTURE_ROOT="poc4_8/tests/fixtures/run_20260129_161814"
          OUT_DIR="$FIXTURE_ROOT/report"
          poc4_7 report --run-root "$FIXTURE_ROOT" --output-dir "$OUT_DIR"
          cat "$OUT_DIR/summary.md" >> "$GITHUB_STEP_SUMMARY"

          escape_html() {
            sed -e 's/&/\\&amp;/g' -e 's/</\\&lt;/g' -e 's/>/\\&gt;/g' "$1"
          }

          LAST_PHASE=""
          LAST_OUTPUT=""
          phase_desc() {
            case "$1" in
              0A) echo "Obligation extraction + indexing" ;;
              1A) echo "Per-obligation implementation locations" ;;
              1B) echo "Code flow + gap hints per obligation" ;;
              2A) echo "Client implementation locations" ;;
              2B) echo "Client gap analysis" ;;
              *) echo "Phase output" ;;
            esac
          }
          for phase in 2B 2A 1B 1A 0A; do
            candidate=$(find "$FIXTURE_ROOT" -type f -name "phase${phase}_output.txt" | sort | tail -n 1)
            if [ -n "$candidate" ]; then
              LAST_PHASE="$phase"
              LAST_OUTPUT="$candidate"
              break
            fi
          done

          for phase in 0A 1A 1B 2A 2B; do
            if [ -n "$LAST_PHASE" ] && [ "$phase" = "$LAST_PHASE" ]; then
              continue
            fi
            candidate=$(find "$FIXTURE_ROOT" -type f -name "phase${phase}_output.txt" | sort | tail -n 1)
            if [ -n "$candidate" ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              desc=$(phase_desc "$phase")
              echo "<details><summary>Phase ${phase} — ${desc} output</summary><pre>" >> "$GITHUB_STEP_SUMMARY"
              escape_html "$candidate" >> "$GITHUB_STEP_SUMMARY"
              echo "</pre></details>" >> "$GITHUB_STEP_SUMMARY"
            fi
          done

          if [ -f "$LAST_OUTPUT" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            last_desc=$(phase_desc "$LAST_PHASE")
            echo "<details><summary>Last phase output ($LAST_PHASE — $last_desc)</summary><pre>" >> "$GITHUB_STEP_SUMMARY"
            escape_html "$LAST_OUTPUT" >> "$GITHUB_STEP_SUMMARY"
            echo "</pre></details>" >> "$GITHUB_STEP_SUMMARY"

            LAST_DIR=$(dirname "$LAST_OUTPUT")
            LAST_CSV=""
            if [ -f "$LAST_DIR/client_obligations_index.csv" ]; then
              LAST_CSV="$LAST_DIR/client_obligations_index.csv"
            elif [ -f "$LAST_DIR/obligations_index.csv" ]; then
              LAST_CSV="$LAST_DIR/obligations_index.csv"
            else
              LAST_CSV=$(find "$LAST_DIR" -maxdepth 1 -type f -name "*obligations_index.csv" | sort | head -n 1)
            fi
            if [ -n "$LAST_CSV" ] && [ -f "$LAST_CSV" ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "<details><summary>Last phase CSV ($LAST_PHASE — $last_desc)</summary><pre>" >> "$GITHUB_STEP_SUMMARY"
              escape_html "$LAST_CSV" >> "$GITHUB_STEP_SUMMARY"
              echo "</pre></details>" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi
